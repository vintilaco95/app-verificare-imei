<%- include('../partials/header', { title: t('dashboard.orders.pageTitle'), user: user }) %>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1><%= t('dashboard.orders.heading') %></h1>
    <div class="dashboard-actions">
      <a href="/dashboard/credits/topup" class="btn btn-secondary"><%= t('dashboard.orders.actions.topup') %></a>
      <a href="/verify/imei" class="btn btn-primary"><%= t('dashboard.orders.actions.newCheck') %></a>
    </div>
  </div>

  <% if (typeof groupedOrders !== 'undefined' && groupedOrders.length > 0) { %>
    <div class="grouped-orders">
      <% groupedOrders.forEach(group => { %>
        <div class="imei-group">
          <div class="imei-group-header" onclick="toggleGroup('<%= group.imei %>')">
            <div class="imei-group-info">
              <h3>
                <span class="imei-code"><%= group.imei %></span>
                <span class="imei-count">(<%= group.count %> <%= t('dashboard.orders.group.count') %>)</span>
              </h3>
              <p class="imei-model"><%= group.model %> - <%= group.brand %></p>
              <p class="imei-last-checked"><%= t('dashboard.orders.group.lastCheck') %>: <%= new Date(group.lastChecked).toLocaleString(currentLang === 'en' ? 'en-US' : 'ro-RO') %></p>
            </div>
            <div class="imei-group-toggle">
              <svg class="toggle-icon" id="icon-<%= group.imei %>" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"></path>
              </svg>
            </div>
          </div>
          
          <div class="imei-group-orders" id="group-<%= group.imei %>" style="display: none;">
            <% group.orders.forEach(order => { %>
              <div class="order-item">
                <div class="order-info">
                  <p class="order-date"><strong><%= t('dashboard.orders.labels.date') %>:</strong> <%= new Date(order.createdAt).toLocaleString(currentLang === 'en' ? 'en-US' : 'ro-RO') %></p>
                  <p class="order-model"><%= order.model || t('common.labels.unknown') %></p>
                  <p class="order-cost"><%= t('dashboard.orders.labels.cost') %>: <%= order.price.toFixed(2) %> <%= t('common.labels.credits') %></p>
                  <% if (order.additionalServices && order.additionalServices.length > 0) { %>
                    <p class="order-additional">
                      <strong><%= t('dashboard.orders.labels.additionalChecks') %>:</strong> 
                      <span class="additional-badge"><%= order.additionalServices.length %> <%= t('dashboard.orders.labels.checksCount') %></span>
                    </p>
                  <% } %>
                </div>
                <div class="order-actions">
                  <span class="status-badge status-<%= order.status %>">
                    <%= t(`status.${order.status}`) %>
                  </span>
                  <% if (order.status === 'success' || order.status === 'failed') { %>
                    <a href="/verify/result/<%= order._id %>" class="btn btn-sm"><%= t('dashboard.orders.actions.viewResult') %></a>
                  <% } else if (order.status === 'pending') { %>
                    <a href="/verify/processing/<%= order._id %>" class="btn btn-sm"><%= t('dashboard.orders.actions.viewStatus') %></a>
                  <% } else { %>
                    <span class="btn btn-sm" style="opacity: 0.5; cursor: not-allowed;">N/A</span>
                  <% } %>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      <% }); %>
    </div>
  <% } else if (orders.length > 0) { %>
    <div class="orders-table">
      <% orders.forEach(order => { %>
        <div class="order-item">
          <div class="order-info">
            <p class="order-imei"><strong>IMEI:</strong> <%= order.imei %></p>
            <p class="order-model"><%= order.model || t('common.labels.unknown') %></p>
            <p class="order-brand"><%= order.brand || 'N/A' %></p>
            <p class="order-date"><%= new Date(order.createdAt).toLocaleString(currentLang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <p class="order-cost"><%= t('dashboard.orders.labels.cost') %>: <%= order.price.toFixed(2) %> <%= t('common.labels.credits') %></p>
            <% if (order.additionalServices && order.additionalServices.length > 0) { %>
              <p class="order-additional">
                <strong><%= t('dashboard.orders.labels.additionalChecks') %>:</strong> 
                <span class="additional-badge"><%= order.additionalServices.length %> <%= t('dashboard.orders.labels.checksCount') %></span>
              </p>
            <% } %>
          </div>
          <div class="order-actions">
            <span class="status-badge status-<%= order.status %>">
              <%= t(`status.${order.status}`) %>
            </span>
            <% if (order.status === 'success' || order.status === 'failed') { %>
              <a href="/verify/result/<%= order._id %>" class="btn btn-sm"><%= t('dashboard.orders.actions.viewResult') %></a>
            <% } else if (order.status === 'pending') { %>
              <a href="/verify/processing/<%= order._id %>" class="btn btn-sm"><%= t('dashboard.orders.actions.viewStatus') %></a>
            <% } else { %>
              <span class="btn btn-sm" style="opacity: 0.5; cursor: not-allowed;">N/A</span>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <p><%= t('dashboard.orders.empty') %></p>
      <a href="/verify/imei" class="btn btn-primary"><%= t('dashboard.orders.actions.checkFirst') %></a>
    </div>
  <% } %>
</div>

<script>
  function toggleGroup(imei) {
    const group = document.getElementById('group-' + imei);
    const header = event.currentTarget;
    const icon = document.getElementById('icon-' + imei);
    
    if (group.style.display === 'none') {
      group.style.display = 'block';
      header.classList.add('active');
    } else {
      group.style.display = 'none';
      header.classList.remove('active');
    }
  }
</script>

<%- include('../partials/footer') %>
