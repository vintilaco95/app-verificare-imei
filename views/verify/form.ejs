<%- include('../partials/header', { title: t('verify.form.pageTitle'), user: user }) %>

<% 
  const locale = currentLang === 'en' ? 'en-US' : 'ro-RO';
  const creditUnitValue = typeof creditValue !== 'undefined' ? creditValue : 1;
  const currencyCodeValue = typeof currencyCode !== 'undefined' ? currencyCode : 'RON';
  const guestVerificationCreditsValue = typeof guestVerificationCredits !== 'undefined'
    ? guestVerificationCredits
    : 3;
  const brandLabels = {
    apple: t('verify.form.brands.apple'),
    samsung: t('verify.form.brands.samsung'),
    honor: t('verify.form.brands.honor'),
    huawei: t('verify.form.brands.huawei'),
    xiaomi: t('verify.form.brands.xiaomi'),
    oneplus: t('verify.form.brands.oneplus'),
    motorola: t('verify.form.brands.motorola'),
    default: t('verify.form.brands.default')
  };
  const brandDescriptions = {
    apple: t('verify.form.brandDescriptions.apple'),
    samsung: t('verify.form.brandDescriptions.samsung'),
    honor: t('verify.form.brandDescriptions.honor'),
    huawei: t('verify.form.brandDescriptions.huawei'),
    xiaomi: t('verify.form.brandDescriptions.xiaomi'),
    oneplus: t('verify.form.brandDescriptions.oneplus'),
    motorola: t('verify.form.brandDescriptions.motorola'),
    default: t('verify.form.brandDescriptions.default')
  };
  const brandIcons = {
    apple: 'ðŸŽ',
    samsung: 'ðŸ“±',
    honor: 'ðŸ†',
    huawei: 'ðŸ‡¨ðŸ‡³',
    xiaomi: 'ðŸ“²',
    oneplus: 'âš¡',
    motorola: 'ðŸ“¶',
    default: 'ðŸŒ'
  };
  const formatCredits = (value) => {
    const num = Number(value);
    if (Number.isNaN(num)) return value;
    return Number.isInteger(num) ? num.toFixed(0) : num.toFixed(2);
  };
  const formatCurrencyAmount = (value) => {
    const num = Number(value);
    if (Number.isNaN(num)) return value;
    return (num * creditUnitValue).toFixed(2);
  };
%>

<div class="verify-container">
  <div class="verify-card">
    <h1 class="verify-title"><%= t('verify.form.heading') %></h1>
    <p class="verify-subtitle">
      <%= t('verify.form.subtitle') %>
    </p>
    
    <%- include('../partials/flash', { errors: errors }) %>
    
    <% if (user) { %>
      <!-- Authenticated user form -->
      <form action="/verify/imei" method="POST" class="verify-form" id="verify-form">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <div class="form-group">
          <label for="imei"><%= t('verify.form.fields.imei.label') %></label>
          <input 
            type="text" 
            id="imei" 
            name="imei" 
            required 
            pattern="[0-9]{15}"
            maxlength="15"
            placeholder="<%= t('verify.form.fields.imei.placeholder') %>"
            class="imei-input"
            autocomplete="off"
          >
          <small class="form-hint"><%= t('verify.form.fields.imei.hint') %></small>
          <div id="imei-error" class="imei-feedback" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem;"></div>
          <div id="imei-valid" class="imei-feedback" style="color: #22c55e; font-size: 0.85rem; margin-top: 0.5rem;"></div>

          <div class="imei-ocr-wrapper">
            <button
              type="button"
              class="btn btn-secondary imei-ocr-button"
              data-target="#imei"
              data-text-loading="<%= t('verify.form.ocr.loading') %>"
              data-text-scanning="<%= t('verify.form.ocr.scanning') %>"
              data-text-error="<%= t('verify.form.ocr.error') %>"
              data-text-success="<%= t('verify.form.ocr.success') %>"
              data-text-permission="<%= t('verify.form.ocr.permissionDenied') %>"
              data-text-unsupported="<%= t('verify.form.ocr.cameraUnsupported') %>"
              data-text-capture="<%= t('verify.form.ocr.capture') %>"
              data-text-close="<%= t('verify.form.ocr.close') %>"
              data-text-gallery="<%= t('verify.form.ocr.gallery') %>"
              data-text-preview="<%= t('verify.form.ocr.previewLabel') %>"
              data-text-instructions="<%= t('verify.form.ocr.instructions') %>"
            >
              <span class="imei-ocr-emoji" aria-hidden="true">ðŸ“·</span>
              <span class="sr-only"><%= t('verify.form.ocr.camera') %></span>
            </button>
            <input type="file" accept="image/*" class="imei-ocr-file" data-target="#imei" hidden>
            <small class="imei-ocr-feedback" data-target="#imei"></small>
          </div>
          
          <!-- Previous Verifications -->
          <div id="previous-verifications" class="previous-verifications" style="display: none; margin-top: 1rem;">
            <div class="previous-verifications-header">
              <span class="previous-icon">ðŸ“‹</span>
              <span class="previous-text"><%= t('verify.form.previousChecks.title') %></span>
            </div>
            <div id="previous-verifications-list" class="previous-verifications-list"></div>
          </div>
        </div>
        
        <!-- Additional Services (will be available after brand detection via API) -->
        <div id="additional-services" class="additional-services" style="display: none; margin-top: 1.5rem;">
          <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-primary);"><%= t('verify.form.additional.heading') %></h3>
          <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            <%= t('verify.form.additional.description') %>
          </p>
          <div id="additional-services-list"></div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large btn-block" id="submit-btn">
          <span><%= t('verify.form.actions.submit') %></span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </button>
      </form>
      
      <% if (pricing) { %>
        <section class="pricing-section verify-pricing">
          <h2 class="section-title"><%= t('verify.form.pricing.title') %></h2>
          <p class="section-subtitle"><%= t('verify.form.pricing.subtitleAuth') %></p>
          <div class="pricing-grid pricing-grid-compact">
            <% Object.keys(pricing).forEach(function(key) { %>
              <div class="pricing-card">
                <div class="pricing-brand">
                  <%= `${brandIcons[key] || brandIcons.default} ${brandLabels[key] || key}` %>
                </div>
                <div class="pricing-price"><%= formatCredits(pricing[key]) %> <span class="pricing-currency"><%= t('common.labels.credits') %></span></div>
                <p class="pricing-description"><%= brandDescriptions[key] || brandDescriptions.default %></p>
              </div>
            <% }); %>
          </div>
        </section>
      <% } %>
    <% } else { %>
      <!-- Guest user form -->
      <form action="/verify/imei/guest" method="POST" class="verify-form" id="verify-form-guest">
        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
        <div class="form-group">
          <label for="imei-guest"><%= t('verify.form.fields.imei.label') %></label>
          <input 
            type="text" 
            id="imei-guest" 
            name="imei" 
            required 
            pattern="[0-9]{15}"
            maxlength="15"
            placeholder="<%= t('verify.form.fields.imei.placeholder') %>"
            class="imei-input"
            autocomplete="off"
          >
          <small class="form-hint"><%= t('verify.form.fields.imei.hint') %></small>
          <div id="imei-error-guest" class="imei-feedback" style="color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem;"></div>
          <div id="imei-valid-guest" class="imei-feedback" style="color: #22c55e; font-size: 0.85rem; margin-top: 0.5rem;"></div>

          <div class="imei-ocr-wrapper">
            <button
              type="button"
              class="btn btn-secondary imei-ocr-button"
              data-target="#imei-guest"
              data-text-loading="<%= t('verify.form.ocr.loading') %>"
              data-text-scanning="<%= t('verify.form.ocr.scanning') %>"
              data-text-error="<%= t('verify.form.ocr.error') %>"
              data-text-success="<%= t('verify.form.ocr.success') %>"
              data-text-permission="<%= t('verify.form.ocr.permissionDenied') %>"
              data-text-unsupported="<%= t('verify.form.ocr.cameraUnsupported') %>"
              data-text-capture="<%= t('verify.form.ocr.capture') %>"
              data-text-close="<%= t('verify.form.ocr.close') %>"
              data-text-gallery="<%= t('verify.form.ocr.gallery') %>"
              data-text-preview="<%= t('verify.form.ocr.previewLabel') %>"
              data-text-instructions="<%= t('verify.form.ocr.instructions') %>"
            >
              <span class="imei-ocr-emoji" aria-hidden="true">ðŸ“·</span>
              <span class="sr-only"><%= t('verify.form.ocr.camera') %></span>
            </button>
            <input type="file" accept="image/*" class="imei-ocr-file" data-target="#imei-guest" hidden>
            <small class="imei-ocr-feedback" data-target="#imei-guest"></small>
          </div>
        </div>
        
        <div class="form-group">
          <label for="email"><%= t('verify.form.fields.email.label') %></label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required 
            placeholder="<%= t('verify.form.fields.email.placeholder') %>"
          >
        </div>
        
        <div class="form-group">
          <label for="brand"><%= t('verify.form.fields.brand.label') %></label>
          <select id="brand" name="brand" required>
            <option value=""><%= t('verify.form.fields.brand.placeholder') %></option>
            <% Object.keys(pricing || {}).forEach(function(key) { %>
              <% if (key !== 'default') { %>
                <option value="<%= key %>" <%= selectedBrand === key ? 'selected' : '' %>><%= brandLabels[key] || key %></option>
              <% } %>
            <% }); %>
            <option value="default" <%= selectedBrand === 'default' ? 'selected' : '' %>><%= t('verify.form.fields.brand.otherOption') %></option>
          </select>
          <small class="form-hint"><%= t('verify.form.fields.brand.hint') %></small>
        </div>
        
        <div class="guest-price-info" id="guest-price-info">
          <span class="guest-price-label"><%= t('verify.form.guest.price.label') %></span>
          <span class="guest-price-value" id="guest-price-value">â€”</span>
        </div>
        
        <!-- Additional Services (will be available after brand detection via API) -->
        <div id="additional-services-guest" class="additional-services" style="display: none; margin-top: 1.5rem;">
          <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-primary);"><%= t('verify.form.additional.heading') %></h3>
          <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
            <%= t('verify.form.additional.description') %>
          </p>
          <div id="additional-services-list-guest"></div>
        </div>
        
        <button type="submit" class="btn btn-primary btn-large btn-block" id="submit-btn-guest">
          <span><%= t('verify.form.actions.submit') %></span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"></path>
          </svg>
        </button>
      </form>
      
      <% if (pricing) { %>
        <section class="pricing-section verify-pricing">
          <h2 class="section-title"><%= t('verify.form.pricing.title') %></h2>
          <p class="section-subtitle"><%= t('verify.form.pricing.subtitleGuest') %></p>
          <div class="pricing-grid pricing-grid-compact">
            <% Object.keys(pricing).forEach(function(key) { %>
              <div class="pricing-card">
                <div class="pricing-brand">
                  <%= `${brandIcons[key] || brandIcons.default} ${brandLabels[key] || key}` %>
                </div>
                <div class="pricing-price">
                  <span class="pricing-primary"><%= formatCurrencyAmount(pricing[key]) %> <%= currencyCodeValue %></span>
                  <span class="pricing-secondary">â‰ˆ <%= formatCredits(pricing[key]) %> <%= t('common.labels.credits') %></span>
                </div>
                <p class="pricing-description"><%= brandDescriptions[key] || brandDescriptions.default %></p>
              </div>
            <% }); %>
          </div>
        </section>
      <% } %>
    <% } %>
  </div>
</div>

<script>
  window.serverPricing = <%- JSON.stringify(pricing || {}) %>;
  window.creditValue = <%= creditUnitValue %>;
  window.currencyCode = <%- JSON.stringify(currencyCodeValue) %>;
  window.guestVerificationCredits = <%= guestVerificationCreditsValue %>;
</script>
<script src="/js/imei-validator.js"></script>
<script src="/js/pricing.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="/js/imei-scanner.js"></script>
<script>
  // Initialize IMEI validation when page loads
  document.addEventListener('DOMContentLoaded', function() {
    const appLocale = '<%= locale %>';
    const statusTexts = {
      pending: '<%= t('status.pending') %>',
      success: '<%= t('status.success') %>',
      failed: '<%= t('status.failed') %>',
      error: '<%= t('status.error') %>'
    };
    const previousOpenLabel = '<%= t('verify.form.previousChecks.open') %>';
    const previousSeeAllLabel = '<%= t('verify.form.previousChecks.seeAll') %>';
    const creditsLabel = '<%= t('common.labels.credits') %>';
    const currencyLabelRaw = window.currencyCode || '<%= currencyCodeValue %>';
    const currencyLabel = (currencyLabelRaw || 'RON').toUpperCase();
    const rawCreditValue = parseFloat(window.creditValue !== undefined ? window.creditValue : '<%= creditUnitValue %>');
    const creditUnitValueGuest = (!isNaN(rawCreditValue) && rawCreditValue > 0) ? rawCreditValue : <%= creditUnitValue %>;
    const rawGuestCredits = parseFloat(
      window.guestVerificationCredits !== undefined
        ? window.guestVerificationCredits
        : '<%= guestVerificationCreditsValue %>'
    );
    const guestVerificationCredits = (!isNaN(rawGuestCredits) && rawGuestCredits > 0)
      ? rawGuestCredits
      : <%= guestVerificationCreditsValue %>;
    function formatCreditDisplay(value) {
      if (typeof value !== 'number' || isNaN(value)) return value;
      return Number.isInteger(value) ? value.toString() : value.toFixed(2);
    }

    const validationImeiMessage = '<%= t('verify.form.validation.invalidImei') %>';
    const validationSelectBrandMessage = '<%= t('verify.form.validation.selectBrand') %>';

    <% if (user) { %>
      // Authenticated user form
      const imeiInput = document.getElementById('imei');
      const imeiError = document.getElementById('imei-error');
      const imeiValid = document.getElementById('imei-valid');
      const form = document.getElementById('verify-form');
      
      initIMEIValidation('imei');
      
      // Check for previous verifications
      let checkTimeout;
      async function checkPreviousVerifications(imei) {
        if (!imei || imei.length !== 15) {
          document.getElementById('previous-verifications').style.display = 'none';
          return;
        }
        
        try {
          const response = await fetch(`/verify/imei/check/${imei}`);
          const data = await response.json();
          
          const prevContainer = document.getElementById('previous-verifications');
          const prevList = document.getElementById('previous-verifications-list');
          
          if (data.found && data.orders && data.orders.length > 0) {
            prevContainer.style.display = 'block';
            prevList.innerHTML = '';
            
            data.orders.forEach(order => {
              const orderDiv = document.createElement('div');
              orderDiv.className = 'previous-order-item';
              
              const date = new Date(order.date).toLocaleString(appLocale);
              const statusText = statusTexts[order.status] || order.status;
              
              const statusClass = `status-${order.status}`;
              
              orderDiv.innerHTML = `
                <div class="previous-order-info">
                  <span class="previous-order-date">${date}</span>
                  <span class="previous-order-model">${order.model} - ${order.brand}</span>
                  <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <a href="/verify/result/${order.id}" class="btn btn-sm">${previousOpenLabel}</a>
              `;
              
              prevList.appendChild(orderDiv);
            });
            
            if (data.count > data.orders.length) {
              const moreDiv = document.createElement('div');
              moreDiv.className = 'previous-order-more';
              moreDiv.innerHTML = `<a href="/dashboard/orders" class="btn btn-sm btn-secondary">${previousSeeAllLabel} (${data.count})</a>`;
              prevList.appendChild(moreDiv);
            }
          } else {
            prevContainer.style.display = 'none';
          }
        } catch (error) {
          console.error('Error checking previous verifications:', error);
          document.getElementById('previous-verifications').style.display = 'none';
        }
      }
      
      // IMEI input handler - only validate, don't detect brand
      imeiInput.addEventListener('input', function() {
        const value = this.value.replace(/\D/g, '').substring(0, 15);
        
        // Clear previous timeout
        clearTimeout(checkTimeout);
        
        if (value.length === 15 && validateIMEI(value)) {
          // Hide additional services (will be available after API detects brand)
          document.getElementById('additional-services').style.display = 'none';
          
          // Check for previous verifications after a short delay
          checkTimeout = setTimeout(() => {
            checkPreviousVerifications(value);
          }, 500);
        } else {
          // Hide additional services and previous verifications if IMEI is invalid
          document.getElementById('additional-services').style.display = 'none';
          document.getElementById('previous-verifications').style.display = 'none';
        }
      });
      
      // Validate before submit
      form.addEventListener('submit', function(e) {
        const value = imeiInput.value.replace(/\D/g, '');
        if (value.length !== 15 || !validateIMEI(value)) {
          e.preventDefault();
          if (imeiError) {
            imeiError.textContent = validationImeiMessage;
            imeiError.style.color = '#ef4444';
          }
          imeiInput.style.borderColor = '#ef4444';
          return false;
        }
      });
    <% } else { %>
      // Guest user form
      const imeiInputGuest = document.getElementById('imei-guest');
      const imeiErrorGuest = document.getElementById('imei-error-guest');
      const imeiValidGuest = document.getElementById('imei-valid-guest');
      const formGuest = document.getElementById('verify-form-guest');
      const brandSelect = document.getElementById('brand');
      const guestPriceValue = document.getElementById('guest-price-value');
      
      initIMEIValidation('imei-guest');

      function updateGuestPriceDisplay() {
        if (!guestPriceValue) return;
        const brand = brandSelect ? brandSelect.value : '';
        if (!brand) {
          guestPriceValue.textContent = 'â€”';
          return;
        }

        const serverConfiguredCredits = window.serverPricing && typeof window.serverPricing[brand] !== 'undefined'
          ? Number(window.serverPricing[brand])
          : NaN;
        const baseCredits = (!isNaN(guestVerificationCredits) && guestVerificationCredits > 0)
          ? guestVerificationCredits
          : (!isNaN(serverConfiguredCredits) ? serverConfiguredCredits : guestVerificationCredits);

        if (isNaN(baseCredits)) {
          guestPriceValue.textContent = 'â€”';
          return;
        }

        let totalCredits = baseCredits;
        const additionalList = document.getElementById('additional-services-list-guest');
        if (additionalList) {
          const extraCredits = Array.from(additionalList.querySelectorAll('.service-checkbox-input:checked'))
            .reduce((sum, checkbox) => {
              const price = parseFloat(checkbox.dataset.price || '0');
              return isNaN(price) ? sum : sum + price;
            }, 0);
          totalCredits += extraCredits;
        }

        const totalCreditsFormatted = formatCreditDisplay(totalCredits);
        const currencyAmount = (totalCredits * creditUnitValueGuest).toFixed(2);
        guestPriceValue.textContent = `${currencyAmount} ${currencyLabel} (â‰ˆ ${totalCreditsFormatted} ${creditsLabel})`;
      }
      window.updateGuestPriceDisplay = updateGuestPriceDisplay;
      
      if (brandSelect) {
        brandSelect.addEventListener('change', updateGuestPriceDisplay);
        updateGuestPriceDisplay();
      }
      
      // IMEI input handler - only validate, don't detect brand
      imeiInputGuest.addEventListener('input', function() {
        const value = this.value.replace(/\D/g, '').substring(0, 15);
        
        if (value.length === 15 && validateIMEI(value)) {
          // Hide additional services (will be available after API detects brand)
          document.getElementById('additional-services-guest').style.display = 'none';
        } else {
          // Hide additional services if IMEI is invalid and reset cost
          document.getElementById('additional-services-guest').style.display = 'none';
        }
      });
      
      // Validate before submit
      formGuest.addEventListener('submit', function(e) {
        const value = imeiInputGuest.value.replace(/\D/g, '');
        const brand = brandSelect ? brandSelect.value : '';
        if (value.length !== 15 || !validateIMEI(value)) {
          e.preventDefault();
          if (imeiErrorGuest) {
            imeiErrorGuest.textContent = validationImeiMessage;
            imeiErrorGuest.style.color = '#ef4444';
          }
          imeiInputGuest.style.borderColor = '#ef4444';
          return false;
        }
        if (!brand) {
          e.preventDefault();
          if (imeiErrorGuest) {
            imeiErrorGuest.textContent = validationSelectBrandMessage;
            imeiErrorGuest.style.color = '#ef4444';
          }
          return false;
        }
      });
    <% } %>
  });
</script>

<%- include('../partials/footer') %>
