<%- include('../partials/header', { title: t('verify.processing.pageTitle'), user: user }) %>

<div class="processing-container">
  <div class="processing-card">
    <div class="processing-icon">
      <div class="spinner"></div>
    </div>
    <h1 class="processing-title"><%= t('verify.processing.heading') %></h1>
    <p class="processing-subtitle"><%- t('verify.processing.subtitle').replace('{imei}', `<strong>${order.imei}</strong>`) %></p>
    
    <div class="processing-status">
      <div class="status-indicator">
        <div class="status-dot active"></div>
        <span><%= t('verify.processing.status.started') %></span>
      </div>
      <div class="status-indicator" id="status-processing">
        <div class="status-dot"></div>
        <span><%= t('verify.processing.status.processing') %></span>
      </div>
      <div class="status-indicator" id="status-completed">
        <div class="status-dot"></div>
        <span><%= t('verify.processing.status.completed') %></span>
      </div>
    </div>
    
    <div class="processing-info">
      <p><%- t('verify.processing.info.dashboard').replace('{link}', '<a href="/dashboard/orders">Dashboard</a>') %></p>
      <p class="info-hint"><%= t('verify.processing.info.hint') %></p>
    </div>
    
    <div class="processing-actions">
      <a href="/dashboard/orders" class="btn btn-primary"><%= t('verify.processing.actions.viewAll') %></a>
      <a href="/verify/imei" class="btn btn-secondary"><%= t('verify.processing.actions.newCheck') %></a>
    </div>
  </div>
</div>

<script>
  const orderId = '<%= order._id %>';
  let checkInterval;
  let checkCount = 0;
  const maxChecks = 60; // Max 60 checks (2 minutes with 2s interval)
  const processingLabels = {
    timeout: '<%= t('verify.processing.status.timeout') %>',
    error: '<%= t('verify.processing.status.error') %>'
  };
  
  function checkStatus() {
    checkCount++;
    
    if (checkCount > maxChecks) {
      clearInterval(checkInterval);
      document.getElementById('status-processing').querySelector('.status-dot').classList.add('error');
      document.getElementById('status-processing').querySelector('span').textContent = processingLabels.timeout;
      return;
    }
    
    fetch(`/verify/status/${orderId}`)
      .then(response => response.json())
      .then(data => {
        if (data.completed) {
          clearInterval(checkInterval);
          
          // Update status indicators
          document.getElementById('status-processing').querySelector('.status-dot').classList.add('active');
          document.getElementById('status-completed').querySelector('.status-dot').classList.add('active');
          
          if (data.status === 'success') {
            // Redirect to result page
            setTimeout(() => {
              window.location.href = data.resultUrl;
            }, 1000);
          } else {
            // Show error or redirect
            document.getElementById('status-completed').querySelector('.status-dot').classList.add('error');
            document.getElementById('status-completed').querySelector('span').textContent = processingLabels.error;
            
            setTimeout(() => {
              if (data.resultUrl) {
                window.location.href = data.resultUrl;
              } else {
                window.location.href = '/dashboard/orders';
              }
            }, 2000);
          }
        }
      })
      .catch(error => {
        console.error('Error checking status:', error);
      });
  }
  
  // Start checking status every 2 seconds
  checkInterval = setInterval(checkStatus, 2000);
  
  // Check immediately
  checkStatus();
</script>

<style>
  .processing-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 200px);
    padding: 2rem;
  }
  
  .processing-card {
    background: var(--bg-card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 3rem;
    width: 100%;
    max-width: 600px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }
  
  .processing-icon {
    margin-bottom: 2rem;
  }
  
  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(20, 184, 166, 0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .processing-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--text-primary);
  }
  
  .processing-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
  }
  
  .processing-status {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 2rem 0;
    text-align: left;
  }
  
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.3);
    border-radius: 8px;
  }
  
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(226, 232, 240, 0.3);
    transition: all 0.3s ease;
  }
  
  .status-dot.active {
    background: var(--primary);
    box-shadow: 0 0 10px rgba(20, 184, 166, 0.5);
  }
  
  .status-dot.error {
    background: var(--danger);
  }
  
  .status-indicator span {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }
  
  .status-indicator .status-dot.active + span {
    color: var(--text-primary);
  }
  
  .processing-info {
    margin: 2rem 0;
    padding: 1.5rem;
    background: rgba(20, 184, 166, 0.1);
    border: 1px solid rgba(20, 184, 166, 0.2);
    border-radius: 12px;
  }
  
  .processing-info p {
    margin: 0.5rem 0;
    color: var(--text-primary);
  }
  
  .processing-info a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
  }
  
  .processing-info a:hover {
    text-decoration: underline;
  }
  
  .info-hint {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }
  
  .processing-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
  }
  
  @media (max-width: 768px) {
    .processing-card {
      padding: 2rem;
    }
    
    .processing-actions {
      flex-direction: column;
    }
  }
</style>

<%- include('../partials/footer') %>

