<%- include('../partials/header', { title: title, user: user }) %>

<div class="verify-container">
  <div class="verify-card" style="text-align: center; max-width: 600px; margin: 2rem auto;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">⏳</div>
    <h1 style="color: var(--text-primary); margin-bottom: 1rem;">Așteptare Plată</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
      Plătește pentru a continua verificarea IMEI. După finalizarea plății, verificarea va începe automat.
    </p>
    
    <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
      <p style="margin-bottom: 0.5rem;"><strong>IMEI:</strong> <code><%= order.imei %></code></p>
      <p style="margin-bottom: 0.5rem;"><strong>Email:</strong> <%= order.email %></p>
      <p style="margin-bottom: 0;"><strong>Preț:</strong> <%= order.price.toFixed(2) %> RON</p>
    </div>
    
    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 2rem;">
      Dacă ai finalizat deja plata, pagina se va actualiza automat în câteva secunde.
    </p>
    
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
      <a href="/verify/imei" class="btn btn-secondary">Anulează</a>
    </div>
  </div>
</div>

<script>
  // Poll for payment status
  let pollCount = 0;
  const maxPolls = 60; // 5 minutes (5 second intervals)
  
  function checkPaymentStatus() {
    if (pollCount >= maxPolls) {
      console.log('Payment check timeout');
      return;
    }
    
    pollCount++;
    
    fetch(`/verify/status/<%= order._id %>`)
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success' || data.paymentStatus === 'paid') {
          // Payment completed, reload page to show processing
          window.location.reload();
        } else if (data.status === 'failed' || data.paymentStatus === 'failed') {
          // Payment failed
          window.location.href = '/verify/payment/cancel?order_id=<%= order._id %>';
        } else {
          // Still pending, check again in 5 seconds
          setTimeout(checkPaymentStatus, 5000);
        }
      })
      .catch(error => {
        console.error('Error checking payment status:', error);
        setTimeout(checkPaymentStatus, 5000);
      });
  }
  
  // Start polling after 2 seconds
  setTimeout(checkPaymentStatus, 2000);
</script>

<%- include('../partials/footer') %>

