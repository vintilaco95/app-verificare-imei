<% const isEmailView = typeof isEmail !== 'undefined' && isEmail; %>
<%
  const lang = typeof currentLang !== 'undefined' ? currentLang : (typeof templateData !== 'undefined' && templateData.currentLang ? templateData.currentLang : 'ro');
  const tt = (key) => typeof t === 'function' ? t(key) : key;
  const localizedText = (entry) => {
    if (!entry) return '';
    if (entry.texts && entry.texts[lang]) return entry.texts[lang];
    return entry.text || '';
  };
  const textByLang = (roText, enText) => (lang === 'en' ? enText : roText);
  const riskLabel = (typeof riskTexts !== 'undefined' && riskTexts && riskTexts[lang]) ? riskTexts[lang] : (riskText || '');
  const summaryLabel = (typeof summaryTexts !== 'undefined' && summaryTexts && summaryTexts[lang]) ? summaryTexts[lang] : (summaryText || '');
  const appleMdmData = typeof appleMdm !== 'undefined'
    ? appleMdm
    : (typeof templateData !== 'undefined' && typeof templateData.appleMdm !== 'undefined' ? templateData.appleMdm : null);
  const showAppleMdmButtonFlag = typeof showAppleMdmButton !== 'undefined'
    ? showAppleMdmButton
    : (typeof templateData !== 'undefined' && typeof templateData.showAppleMdmButton !== 'undefined' ? templateData.showAppleMdmButton : false);
  const appleMdmButtonDisabledFlag = typeof appleMdmButtonDisabled !== 'undefined'
    ? appleMdmButtonDisabled
    : (typeof templateData !== 'undefined' && typeof templateData.appleMdmButtonDisabled !== 'undefined' ? templateData.appleMdmButtonDisabled : false);
  const riskScoreMaxValue = typeof riskScoreMax !== 'undefined'
    ? riskScoreMax
    : (typeof templateData !== 'undefined' && typeof templateData.riskScoreMax !== 'undefined' ? templateData.riskScoreMax : 10);
%>
<% if (!isEmailView) { 
  const headerProps = {
    title: title,
    user: user,
    csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : '',
    t: typeof t === 'function' ? t : null,
    currentLang: typeof currentLang !== 'undefined' ? currentLang : null,
    currentLangLabel: typeof currentLangLabel !== 'undefined' ? currentLangLabel : null,
    switchLang: typeof switchLang !== 'undefined' ? switchLang : null,
    switchLangLabel: typeof switchLangLabel !== 'undefined' ? switchLangLabel : null
  };
%>
  <%- include('../partials/header', headerProps) %>
<% } %>

<% 
  // This template is for Apple/other devices
  // Samsung devices are handled in the route
%>

<div class="result-container">
  <% 
    const reportData = order.object || {};
    const isApple = brand === 'apple' || order.brand === 'apple';
    const isSamsung = brand === 'samsung';
    
    const model = reportData.model || order.model || 'Dispozitiv necunoscut';
    const modelDesc = reportData.modelDesc || '';
    const imei = reportData.imei || order.imei;
    const imei2 = reportData.imei2 || '';
    const serial = reportData.serial || '';
    const eid = reportData.eid || '';
    
    // Critical information is already formatted in route handler
    // Use passed variables: iCloud, blacklist, knox, mdm, lostMode, networkLock, warranty, origin
  %>

  <div class="imei-report">
    <!-- HEADER -->
    <div class="report-header">
      <div class="header-content">
        <p class="report-label"><%= tt('verify.result.reportLabel') %></p>
        <h2 class="report-model"><%= model %></h2>
        <% if (modelDesc) { %>
          <p class="report-desc"><%= tt('verify.result.device.providerDescription') %> <strong><%= modelDesc %></strong></p>
        <% } %>
      </div>
      <!-- SCOR RISC -->
      <div class="score-box">
        <p class="score-label"><%= tt('verify.result.scoreLabel') %></p>
        <p class="score-value" style="color: <%= scoreColor %>;"><%= riskScore %> / <%= riskScoreMaxValue %></p>
        <p class="score-text" style="color: <%= scoreColor %>;"><%= riskLabel %></p>
      </div>
    </div>

    <!-- INFORMATII CRITICE DE SECURITATE -->
    <div class="critical-info-section">
      <div class="critical-info-card">
        <h3 class="critical-info-title">üîí <%= tt('verify.result.sections.securityTitle') %></h3>
        
        <div class="critical-info-grid">
          <!-- 1. iCloud Status (iPhone only) -->
          <% if (isApple && iCloud) { %>
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.icloud') %>:</div>
            <div class="critical-info-value status-<%= iCloud.status === 'on' ? 'danger' : iCloud.status === 'off' ? 'safe' : 'unknown' %>">
              <%= localizedText(iCloud) %>
            </div>
          </div>
          <% } %>
          
          <!-- 2. Blacklist Status -->
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.blacklist') %>:</div>
            <div class="critical-info-value status-<%= blacklist.status === 'blacklisted' ? 'danger' : blacklist.status === 'clean' ? 'safe' : 'unknown' %>">
              <%= localizedText(blacklist) %>
            </div>
          </div>
          
          <!-- 3. Knox Guard (Samsung only) -->
          <% if (isSamsung && knox) { %>
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.knox') %>:</div>
            <div class="critical-info-value status-<%= knox.status === 'active' ? 'warning' : knox.status === 'inactive' ? 'safe' : 'unknown' %>">
              <%= localizedText(knox) %>
            </div>
          </div>
          <% } %>
          
          <!-- 4. MDM Lock -->
          <% if (mdm) { %>
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.mdm') %>:</div>
            <div class="critical-info-value status-<%= mdm.status === 'locked' ? 'warning' : mdm.status === 'unlocked' ? 'safe' : 'unknown' %>">
              <%= localizedText(mdm) %>
            </div>
          </div>
          <% } %>
          
          <!-- 5. Lost Mode (iPhone only) -->
          <% if (isApple && lostMode) { %>
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.lostMode') %>:</div>
            <div class="critical-info-value status-<%= lostMode.status === 'active' ? 'danger' : lostMode.status === 'inactive' ? 'safe' : 'unknown' %>">
              <%= localizedText(lostMode) %>
            </div>
          </div>
          <% } %>
          
          <!-- 6. Network Lock -->
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.networkLock') %>:</div>
            <div class="critical-info-value status-<%= networkLock.status === 'locked' ? 'danger' : networkLock.status === 'locked_orange' ? 'warning' : networkLock.status === 'unlocked' ? 'safe' : 'unknown' %>">
              <%= localizedText(networkLock) %>
            </div>
          </div>
          
          <!-- 7. Warranty Info -->
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.warranty') %>:</div>
            <div class="critical-info-value status-<%= warranty && warranty.hasInfo ? (warranty.status === 'active' ? 'safe' : warranty.status === 'expired' ? 'warning' : 'unknown') : 'unknown' %>">
              <%= localizedText(warranty) %>
            </div>
          </div>
          
          <!-- 8. Origin Info -->
          <div class="critical-info-item">
            <div class="critical-info-label"><%= tt('verify.result.labels.origin') %>:</div>
            <div class="critical-info-value <%= origin && origin.hasInfo ? '' : 'status-unknown' %>">
              <%= localizedText(origin) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALERTE (dacƒÉ sunt probleme critice) -->
    <% if (iCloud && iCloud.status === 'on') { %>
      <div class="alert-box">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
          <p><strong><%= tt('verify.result.alerts.icloud.title') %></strong></p>
          <p><%- tt('verify.result.alerts.icloud.message') %></p>
        </div>
      </div>
    <% } %>
    
    <% if (lostMode && lostMode.status === 'active') { %>
      <div class="alert-box" style="background-color: rgba(239, 68, 68, 0.1); border-left-color: #ef4444;">
        <div class="alert-icon">üö®</div>
        <div class="alert-content">
          <p><strong><%= tt('verify.result.alerts.lostMode.title') %></strong></p>
          <p><%- tt('verify.result.alerts.lostMode.message') %></p>
        </div>
      </div>
    <% } %>
    
    <% if (blacklist && blacklist.status === 'blacklisted') { %>
      <div class="alert-box" style="background-color: rgba(239, 68, 68, 0.1); border-left-color: #ef4444;">
        <div class="alert-icon">üö´</div>
        <div class="alert-content">
          <p><strong><%= tt('verify.result.alerts.blacklist.title') %></strong></p>
          <p><%- tt('verify.result.alerts.blacklist.message') %></p>
        </div>
      </div>
    <% } %>

    <!-- INFORMATII SUPLIMENTARE -->
    <div class="report-grid">
      <!-- IDENTIFICARE -->
      <div class="report-card">
        <h3><%= tt('verify.result.device.title') %></h3>
        <p><%= tt('verify.result.device.modelLabel') %> <strong><%= model %></strong></p>
        <% if (modelDesc) { %>
          <p><%= tt('verify.result.device.descriptionLabel') %> <strong><%= modelDesc %></strong></p>
        <% } %>
        <p><%= tt('verify.result.device.imeiLabel') %> <strong><%= imei %></strong></p>
        <% if (imei2) { %>
          <p><%= tt('verify.result.device.imei2Label') %> <strong><%= imei2 %></strong></p>
        <% } %>
        <% if (serial) { %>
          <p><%= tt('verify.result.device.serialLabel') %> <strong><%= serial %></strong></p>
        <% } %>
        <% if (eid) { %>
          <p><%= tt('verify.result.device.eidLabel') %> <code><%= eid %></code></p>
        <% } %>
      </div>
    </div>

    <!-- SFATURI -->
    <div class="report-tips">
      <h3><%= tt('verify.result.tips.title') %></h3>
      <ol>
        <% const tipsList = []; %>
        <% if (isApple) { %>
          <% tipsList.push('verify.result.tips.apple.deactivateIcloud', 'verify.result.tips.apple.resetDevice'); %>
        <% } else { %>
          <% tipsList.push('verify.result.tips.generic.checkBlacklist', 'verify.result.tips.generic.reset'); %>
        <% } %>
        <% tipsList.push('verify.result.tips.common.verifyInvoice', 'verify.result.tips.common.testHardware', 'verify.result.tips.common.checkBattery'); %>
        <% if (!isApple) { tipsList.push('verify.result.tips.common.installUpdates'); } %>
        <% tipsList.forEach(key => { %>
          <li><%= tt(key) %></li>
        <% }); %>
      </ol>
    </div>

    <!-- CONCLUZIE -->
    <div class="report-conclusion">
      <div class="conclusion-box">
        <p><strong><%= tt('verify.result.conclusion.label') %></strong> <%= summaryLabel %></p>
      </div>
    </div>

    <!-- DATE SERVICIU 9 (PROVENIEN»öƒÇ »òI RISC) -->
    <% 
      // Check if service9Data exists - handle both object and string formats
      let service9Data = null;
      if (order.object) {
        // If order.object is a string, try to parse it
        if (typeof order.object === 'string') {
          try {
            const parsed = JSON.parse(order.object);
            service9Data = parsed.service9Data;
          } catch (e) {
            // Not JSON, ignore
          }
        } else if (typeof order.object === 'object') {
          service9Data = order.object.service9Data;
        }
      }
    %>
    <% if (service9Data) { %>
      <% const service9 = service9Data; %>
      <div class="service9-section" style="margin-top: 30px; padding: 20px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border-left: 4px solid #3b82f6;">
        <h2 class="section-title" style="color: #3b82f6; margin-bottom: 20px;">
          <%= tt('verify.result.service9.title') %>
        </h2>
        
        <div class="report-grid">
          <div class="report-card">
            <h3><%= tt('verify.result.service9.deviceTitle') %></h3>
            <% if (service9.modelDescription) { %>
              <p><strong><%= tt('verify.result.service9.labels.model') %></strong> <%= service9.modelDescription %></p>
            <% } %>
            <% if (service9.model) { %>
              <p><strong><%= tt('verify.result.service9.labels.modelFull') %></strong> <%= service9.model %></p>
            <% } %>
            <% if (service9.mpn) { %>
              <p><strong><%= tt('verify.result.service9.labels.mpn') %></strong> <%= service9.mpn %></p>
            <% } %>
            <% if (service9.imei) { %>
              <p><strong><%= tt('verify.result.service9.labels.imei') %></strong> <%= service9.imei %></p>
            <% } %>
            <% if (service9.imei2) { %>
              <p><strong><%= tt('verify.result.service9.labels.imei2') %></strong> <%= service9.imei2 %></p>
            <% } %>
            <% if (service9.serial) { %>
              <p><strong><%= tt('verify.result.service9.labels.serial') %></strong> <%= service9.serial %></p>
            <% } %>
            <% if (service9.productVersion) { %>
              <p><strong><%= tt('verify.result.service9.labels.iosVersion') %></strong> <%= service9.productVersion %></p>
            <% } %>
          </div>
          
          <div class="report-card">
            <h3><%= tt('verify.result.service9.originTitle') %></h3>
            <% if (service9.soldToName) { %>
              <p><strong><%= tt('verify.result.service9.labels.soldBy') %></strong> <span style="color: #3b82f6; font-weight: bold;"><%= service9.soldToName %></span></p>
            <% } %>
            <% if (service9.purchaseCountry) { %>
              <p><strong><%= tt('verify.result.service9.labels.purchaseCountry') %></strong> <span style="color: #3b82f6; font-weight: bold;"><%= service9.purchaseCountry %></span></p>
            <% } %>
            <% if (service9.purchaseDate) { %>
              <% 
                const purchaseDate = new Date(service9.purchaseDate);
                const isValidDate = purchaseDate.getFullYear() > 2000;
              %>
              <% if (isValidDate) { %>
                <p><strong><%= tt('verify.result.service9.labels.purchaseDate') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.purchaseDate) : purchaseDate.toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
              <% } else { %>
                <p><strong><%= tt('verify.result.service9.labels.purchaseDate') %></strong> <span style="color: #64748b;"><%= tt('verify.result.common.notAvailable') %></span></p>
              <% } %>
            <% } %>
            <% if (service9.firstActivationDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.firstActivation') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.firstActivationDate) : new Date(service9.firstActivationDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
            <% if (service9.carrier) { %>
              <p><strong><%= tt('verify.result.service9.labels.carrier') %></strong> <span style="color: #3b82f6; font-weight: bold;"><%= service9.carrier %></span></p>
            <% } %>
            <% if (service9.registrationDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.registrationDate') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.registrationDate) : new Date(service9.registrationDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
          </div>
          
          <div class="report-card">
            <h3><%= tt('verify.result.service9.gsxTitle') %></h3>
            <% if (service9.gsxUnlocked !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.gsxUnlocked') %></strong>
                <span style="color: <%= service9.gsxUnlocked ? '#22c55e' : '#ef4444' %>; font-weight: bold;">
                  <%= service9.gsxUnlocked ? textByLang('DA - Deblocat', 'YES - Unlocked') : textByLang('NU - Blocat', 'NO - Locked') %>
                </span>
              </p>
            <% } %>
            <% if (service9.unlockDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.gsxUnlockDate') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.unlockDate) : new Date(service9.unlockDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
            <% if (service9.mdmStatus !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.mdmLock') %></strong>
                <span style="color: <%= service9.mdmStatus ? '#ef4444' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.mdmStatus ? textByLang('ACTIV ‚ö†Ô∏è', 'ACTIVE ‚ö†Ô∏è') : textByLang('DEZACTIVAT ‚úì', 'DISABLED ‚úì') %>
                </span>
              </p>
            <% } %>
            <% if (service9.isFMiPActive !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.findMyIphone') %></strong>
                <span style="color: <%= service9.isFMiPActive ? '#ef4444' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.isFMiPActive ? textByLang('ACTIV ‚ö†Ô∏è', 'ACTIVE ‚ö†Ô∏è') : textByLang('DEZACTIVAT ‚úì', 'DISABLED ‚úì') %>
                </span>
              </p>
            <% } %>
            <% if (service9.isLostModeOn !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.lostMode') %></strong>
                <span style="color: <%= service9.isLostModeOn ? '#ef4444' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.isLostModeOn ? textByLang('ACTIV ‚ö†Ô∏è', 'ACTIVE ‚ö†Ô∏è') : textByLang('DEZACTIVAT ‚úì', 'DISABLED ‚úì') %>
                </span>
              </p>
            <% } %>
          </div>
          
          <div class="report-card">
            <h3><%= tt('verify.result.service9.historyTitle') %></h3>
            <% if (service9.gsxCaseHistory !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.gsxCaseHistory') %></strong>
                <span style="color: <%= service9.gsxCaseHistory > 0 ? '#ef4444' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.gsxCaseHistory %> <%= service9.gsxCaseHistory > 0 ? '‚ö†Ô∏è' : '‚úì' %>
                </span>
              </p>
              <% if (service9.gsxCaseHistory > 0) { %>
                <p style="color: #f97316; font-size: 0.9em; margin-top: 5px;">‚ö†Ô∏è <%= tt('verify.result.service9.warnings.caseHistory') %> <%= service9.gsxCaseHistory %></p>
              <% } %>
            <% } %>
            <% if (service9.gsxReplacementHistory !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.gsxReplacementHistory') %></strong>
                <span style="color: <%= service9.gsxReplacementHistory > 0 ? '#f97316' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.gsxReplacementHistory %> <%= service9.gsxReplacementHistory > 0 ? '‚ö†Ô∏è' : '‚úì' %>
                </span>
              </p>
            <% } %>
            <% if (service9.replaced !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.replaced') %></strong>
                <span style="color: <%= service9.replaced ? '#ef4444' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.replaced ? textByLang('DA ‚ö†Ô∏è', 'YES ‚ö†Ô∏è') : textByLang('NU ‚úì', 'NO ‚úì') %>
                </span>
              </p>
            <% } %>
            <% if (service9.loaner !== undefined) { %>
              <p><strong><%= tt('verify.result.service9.labels.loaner') %></strong>
                <span style="color: <%= service9.loaner ? '#f97316' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.loaner ? textByLang('DA ‚ö†Ô∏è', 'YES ‚ö†Ô∏è') : textByLang('NU ‚úì', 'NO ‚úì') %>
                </span>
              </p>
            <% } %>
            <% if (service9.warrantyStatusDescription) { %>
              <p><strong><%= tt('verify.result.service9.labels.warrantyStatus') %></strong>
                <span style="color: <%= service9.warrantyStatusDescription.toLowerCase().includes('out') || service9.warrantyStatusDescription.toLowerCase().includes('no coverage') ? '#f97316' : '#22c55e' %>; font-weight: bold;">
                  <%= service9.warrantyStatusDescription %>
                </span>
              </p>
            <% } %>
            <% if (service9.warrantyStatusCode) { %>
              <p><strong><%= tt('verify.result.service9.labels.warrantyCode') %></strong> <%= service9.warrantyStatusCode %></p>
            <% } %>
            <% if (service9.coverageStartDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.coverageStart') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.coverageStartDate) : new Date(service9.coverageStartDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
            <% if (service9.coverageEndDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.coverageEnd') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.coverageEndDate) : new Date(service9.coverageEndDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
            <% if (service9.contractCoverageStartDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.contractStart') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.contractCoverageStartDate) : new Date(service9.contractCoverageStartDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
            <% if (service9.contractCoverageEndDate) { %>
              <p><strong><%= tt('verify.result.service9.labels.contractEnd') %></strong> <%= typeof formatDate !== 'undefined' ? formatDate(service9.contractCoverageEndDate) : new Date(service9.contractCoverageEndDate).toLocaleDateString(lang === 'en' ? 'en-US' : 'ro-RO') %></p>
            <% } %>
          </div>
          
          <div class="report-card">
            <h3><%= tt('verify.result.service9.policiesTitle') %></h3>
            <% if (service9.initialActivationPolicyDetails) { %>
              <p><strong><%= tt('verify.result.service9.labels.initialPolicy') %></strong>
                <span style="color: <%= service9.initialActivationPolicyDetails.toLowerCase().includes('unlock') ? '#22c55e' : '#f97316' %>;"><%= service9.initialActivationPolicyDetails %></span>
              </p>
            <% } %>
            <% if (service9.appliedActivationDetails) { %>
              <p><strong><%= tt('verify.result.service9.labels.appliedPolicy') %></strong>
                <span style="color: <%= service9.appliedActivationDetails.toLowerCase().includes('unlock') ? '#22c55e' : '#f97316' %>;"><%= service9.appliedActivationDetails %></span>
              </p>
            <% } %>
            <% if (service9.nextTetherPolicyDetails) { %>
              <p><strong><%= tt('verify.result.service9.labels.nextPolicy') %></strong>
                <span style="color: <%= service9.nextTetherPolicyDetails.toLowerCase().includes('unlock') ? '#22c55e' : '#f97316' %>;"><%= service9.nextTetherPolicyDetails %></span>
              </p>
            <% } %>
            <% if (service9.ctoConfiguration) { %>
              <p><strong><%= tt('verify.result.service9.labels.ctoConfiguration') %></strong> <%= service9.ctoConfiguration %></p>
            <% } %>
          </div>
        </div>
        
        <% 
          const hasWarnings = 
            (service9.gsxCaseHistory && service9.gsxCaseHistory > 0) ||
            (service9.replaced === true) ||
            (service9.loaner === true) ||
            (service9.isFMiPActive === true) ||
            (service9.isLostModeOn === true) ||
            (service9.mdmStatus === true);
        %>
        <% if (hasWarnings) { %>
          <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
            <h4 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è <%= tt('verify.result.service9.warnings.title') %></h4>
            <ul style="margin-left: 20px; color: #dc2626;">
              <% if (service9.gsxCaseHistory && service9.gsxCaseHistory > 0) { %>
                <li><%= tt('verify.result.service9.warnings.caseHistoryDetail').replace('{count}', service9.gsxCaseHistory) %></li>
              <% } %>
              <% if (service9.replaced === true) { %>
                <li><%= tt('verify.result.service9.warnings.replaced') %></li>
              <% } %>
              <% if (service9.loaner === true) { %>
                <li><%= tt('verify.result.service9.warnings.loaner') %></li>
              <% } %>
              <% if (service9.isFMiPActive === true) { %>
                <li><%= tt('verify.result.service9.warnings.findMyIphone') %></li>
              <% } %>
              <% if (service9.isLostModeOn === true) { %>
                <li><%= tt('verify.result.service9.warnings.lostMode') %></li>
              <% } %>
              <% if (service9.mdmStatus === true) { %>
                <li><%= tt('verify.result.service9.warnings.mdm') %></li>
              <% } %>
            </ul>
          </div>
        <% } %>
      </div>
    <% } %>

    <!-- VERIFICƒÇRI SUPLIMENTARE -->
    <% if (typeof additionalResults !== 'undefined' && additionalResults && additionalResults.length > 0) { %>
      <div class="additional-results-section">
        <h2 class="section-title"><%= tt('verify.result.additional.title') %></h2>
        <p class="section-subtitle"><%= tt('verify.result.additional.subtitle') %></p>
        
        <% additionalResults.forEach((item, index) => { %>
          <div class="additional-result-card">
            <div class="additional-result-header">
              <h3>
                <span class="result-icon">
                  <% if (item.service.category === 'Provenien»õƒÉ') { %>üîç<% } else if (item.service.category === 'Securitate') { %>üõ°Ô∏è<% } else { %>üì±<% } %>
                </span>
                <%= item.service.displayName || item.service.name %>
              </h3>
              <span class="result-category"><%= item.service.category || tt('verify.result.additional.defaultCategory') %></span>
            </div>
            
            <div class="additional-result-description">
              <p><%= item.service.description %></p>
            </div>
            
            <div class="additional-result-content">
              <% if (item.isHTML) { %>
                <!-- HTML Result -->
                <div class="result-html-content">
                  <%- item.sanitizedHtml || '' %>
                </div>
              <% } else if (item.parsedData) { %>
                <!-- JSON Result -->
                <div class="result-json-content">
                  <% const data = item.parsedData; %>
                  <% if (data.soldBy || data.soldByCountry) { %>
                    <div class="result-field">
                      <strong><%= tt('verify.result.additional.labels.sourceOfPurchase') %></strong>
                      <span><%= data.soldBy || data.soldByCountry || 'N/A' %></span>
                    </div>
                  <% } %>
                  <% if (data.mdmStatus !== undefined) { %>
                    <div class="result-field">
                      <strong><%= tt('verify.result.additional.labels.mdmStatus') %></strong>
                      <span class="<%= data.mdmStatus ? 'status-active' : 'status-inactive' %>">
                        <%= data.mdmStatus ? textByLang('ACTIV', 'ACTIVE') : textByLang('INACTIV', 'INACTIVE') %>
                      </span>
                    </div>
                  <% } %>
                  <% if (data.gsmaStatus) { %>
                    <div class="result-field">
                      <strong><%= tt('verify.result.additional.labels.gsmaStatus') %></strong>
                      <span><%= data.gsmaStatus %></span>
                    </div>
                  <% } %>
                  <% if (data.fmiStatus) { %>
                    <div class="result-field">
                      <strong><%= tt('verify.result.additional.labels.fmiStatus') %></strong>
                      <span class="<%= data.fmiStatus === 'ON' ? 'status-active' : 'status-inactive' %>">
                        <%= data.fmiStatus %>
                      </span>
                    </div>
                  <% } %>
                  <!-- Display other fields if available -->
                  <% Object.keys(data).forEach(key => { %>
                    <% if (!['soldBy', 'soldByCountry', 'mdmStatus', 'gsmaStatus', 'fmiStatus'].includes(key) && data[key] !== null && data[key] !== undefined) { %>
                      <div class="result-field">
                        <strong><%= key %>:</strong>
                        <span><%= typeof data[key] === 'object' ? JSON.stringify(data[key]) : data[key] %></span>
                      </div>
                    <% } %>
                  <% }); %>
                </div>
              <% } else { %>
                <!-- Plain text result -->
                <div class="result-text-content">
                  <pre><%= item.rawResult %></pre>
                </div>
              <% } %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  </div>

  <% if (appleMdmData && appleMdmData.hasData) { %>
    <section class="apple-mdm-section">
      <div class="apple-mdm-header">
        <h2><%= tt('verify.result.appleMdm.title') %></h2>
        <% if (appleMdmData.fetchedAt) { %>
          <span class="apple-mdm-date">
            <%= typeof formatDate !== 'undefined' ? formatDate(appleMdmData.fetchedAt) : new Date(appleMdmData.fetchedAt).toLocaleString(lang === 'en' ? 'en-US' : 'ro-RO') %>
          </span>
        <% } %>
      </div>
      <p class="apple-mdm-subtitle"><%= tt('verify.result.appleMdm.subtitle') %></p>
      <div class="apple-mdm-grid">
        <% appleMdmData.entries.forEach(function(item) { 
             const labelKey = 'verify.result.appleMdm.labels.' + item.key;
             const valueClass = item.isPositive === true ? 'status-positive' : item.isNegative === true ? 'status-negative' : 'status-neutral';
         %>
          <div class="apple-mdm-card">
            <span class="apple-mdm-label"><%= tt(labelKey) %></span>
            <span class="apple-mdm-value <%= valueClass %>"><%= item.raw %></span>
          </div>
        <% }) %>
      </div>
    </section>
  <% } else if (!isEmailView && user && isApple && showAppleMdmButtonFlag && !appleMdmButtonDisabledFlag) { %>
    <section class="apple-mdm-section apple-mdm-empty">
      <p><%= tt('verify.result.appleMdm.noData') %></p>
    </section>
  <% } %>

  <div class="result-actions">
    <% if (user && isApple && showAppleMdmButtonFlag && !appleMdmButtonDisabledFlag) { %>
      <button id="mdm-check-btn" class="btn btn-primary" data-order-id="<%= order._id %>" style="margin-right: 10px;">
        <%= tt('verify.result.actions.mdmCheck') %>
      </button>
    <% } %>
    <% if (user && isApple && (!order.additionalServices || !order.additionalServices.includes(900))) { %>
      <button id="enhance-btn" class="btn btn-primary" data-order-id="<%= order._id %>" style="margin-right: 10px;">
        <%= tt('verify.result.actions.enhance') %>
      </button>
    <% } %>
    <a href="/verify/imei" class="btn btn-secondary"><%= tt('verify.result.actions.checkAnother') %></a>
    <% if (user) { %>
      <a href="/dashboard/orders" class="btn btn-primary"><%= tt('verify.result.actions.viewAll') %></a>
    <% } %>
  </div>
  
  <% if (user && isApple) { %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const enhanceBtn = document.getElementById('enhance-btn');
      const mdmBtn = document.getElementById('mdm-check-btn');
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfToken = (csrfMeta && csrfMeta.getAttribute('content')) || window.csrfToken || '';
      window.csrfToken = csrfToken;

      if (mdmBtn) {
        mdmBtn.addEventListener('click', async function() {
          if (!confirm(<%= JSON.stringify(tt('verify.result.actions.mdmCheckConfirm')) %>)) {
            return;
          }
          const orderId = mdmBtn.getAttribute('data-order-id');
          mdmBtn.disabled = true;
          mdmBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.mdmCheckProcessing')) %>;
          try {
            const response = await fetch(`/verify/apple-mdm/${orderId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken,
                'csrf-token': csrfToken
              },
              credentials: 'same-origin',
              body: JSON.stringify({ _csrf: csrfToken })
            });
            const data = await response.json();
            if (response.ok && data.success) {
              window.location.reload();
            } else {
              alert(data.error || <%= JSON.stringify(tt('verify.result.actions.mdmCheckError')) %>);
              mdmBtn.disabled = false;
              mdmBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.mdmCheck')) %>;
            }
          } catch (error) {
            console.error('Error:', error);
            alert(<%= JSON.stringify(tt('verify.result.actions.mdmCheckError')) %>);
            mdmBtn.disabled = false;
            mdmBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.mdmCheck')) %>;
          }
        });
      }

      if (enhanceBtn) {
        enhanceBtn.addEventListener('click', async function() {
          if (!confirm(<%= JSON.stringify(tt('verify.result.actions.enhanceConfirm')) %>)) {
            return;
          }
          const orderId = enhanceBtn.getAttribute('data-order-id');
          enhanceBtn.disabled = true;
          enhanceBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.enhanceProcessing')) %>;
          try {
            const response = await fetch(`/verify/enhance/${orderId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken,
                'csrf-token': csrfToken
              },
              credentials: 'same-origin',
              body: JSON.stringify({ _csrf: csrfToken })
            });
            const data = await response.json();
            if (response.ok && data.success) {
              window.location.reload();
            } else {
              alert(data.error || <%= JSON.stringify(tt('verify.result.actions.enhanceError')) %>);
              enhanceBtn.disabled = false;
              enhanceBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.enhance')); %>;
            }
          } catch (error) {
            console.error('Error:', error);
            alert(<%= JSON.stringify(tt('verify.result.actions.enhanceError')) %>);
            enhanceBtn.disabled = false;
            enhanceBtn.textContent = <%= JSON.stringify(tt('verify.result.actions.enhance')); %>;
          }
        });
      }
    });
  </script>
  <% } %>
</div>

<% if (!isEmailView) { %>
  <%- include('../partials/footer') %>
<% } %>
