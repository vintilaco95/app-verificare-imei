<% const isEmailView = typeof isEmail !== 'undefined' && isEmail; %>
<% if (!isEmailView) { 
  const headerProps = {
    title: title,
    user: user,
    csrfToken: typeof csrfToken !== 'undefined' ? csrfToken : '',
    t: typeof t === 'function' ? t : null,
    currentLang: typeof currentLang !== 'undefined' ? currentLang : null,
    currentLangLabel: typeof currentLangLabel !== 'undefined' ? currentLangLabel : null,
    switchLang: typeof switchLang !== 'undefined' ? switchLang : null,
    switchLangLabel: typeof switchLangLabel !== 'undefined' ? switchLangLabel : null
  };
%>
  <%- include('../partials/header', headerProps) %>
<% } %>

<div class="result-container">
  <% 
    const tt = (key) => typeof t === 'function' ? t(key) : key;
    // Parse Pixel data from HTML result (data should be pre-parsed in route)
    const pixelData = typeof pixelParsedData !== 'undefined' ? pixelParsedData : {};
    const riskScoreMaxValue = typeof riskScoreMax !== 'undefined'
      ? riskScoreMax
      : (typeof templateData !== 'undefined' && typeof templateData.riskScoreMax !== 'undefined' ? templateData.riskScoreMax : 10);
    
    // Critical information is already formatted in route handler
    // Use passed variables: iCloud, blacklist, knox, mdm, lostMode, networkLock, warranty, origin
    
    const model = pixelData.model || order.model || 'Dispozitiv necunoscut';
    const description = pixelData.description || '';
    const modelNumber = pixelData.modelNumber || '';
    const imei = pixelData.imei || order.imei;
    const serial = pixelData.serial || '';
    const size = pixelData.size || '';
    const color = pixelData.color || '';
    const yearManufactured = pixelData.yearManufactured || '';
    const activationStatus = pixelData.activationStatus || '';
    const warrantyStatus = pixelData.warrantyStatus || pixelData.warranty || '';
    const warrantyEndDate = pixelData.warrantyEndDate || '';
    const hasProvenanceReport = Array.isArray(order && order.additionalServices) && order.additionalServices.includes(9);
    const showProvenanceUpsell = user && !hasProvenanceReport;
    const provenanceCreditsValue = typeof provenancePrice !== 'undefined' ? Number(provenancePrice || 0) : 0;
    const formattedProvenanceCredits = provenanceCreditsValue.toFixed(2);
    const provenanceButtonLabel = `${tt('verify.result.actions.enhanceBase')} (+${formattedProvenanceCredits} ${tt('common.labels.credits')})`;
    const provenanceButtonConfirm = tt('verify.result.actions.enhanceConfirm').replace('{price}', formattedProvenanceCredits);
    const provenanceButtonProcessing = tt('verify.result.actions.enhanceProcessing');
    const provenanceButtonError = tt('verify.result.actions.enhanceError');
  %>

  <div class="imei-report">
    <!-- HEADER -->
    <div class="report-header">
      <div class="header-content">
        <p class="report-label">Rezultat verificare IMEI</p>
        <h2 class="report-model"><%= model %></h2>
        <% if (description && description !== model) { %>
          <p class="report-desc">Descriere: <strong><%= description %></strong></p>
        <% } %>
        <% if (modelNumber) { %>
          <p class="report-desc">Model Number: <strong><%= modelNumber %></strong></p>
        <% } %>
      </div>
      <div class="report-actions">
        <% if (showProvenanceUpsell) { %>
          <button
            type="button"
            class="btn btn-primary btn-provenance"
            id="verify-provenance-btn"
            data-order-id="<%= order._id %>"
            data-label="<%= provenanceButtonLabel %>"
            data-confirm="<%= provenanceButtonConfirm %>"
            data-processing="<%= provenanceButtonProcessing %>"
            data-error="<%= provenanceButtonError %>">
            <span class="btn-text"><%= tt('verify.result.actions.enhanceBase') %></span>
            <span class="btn-price">+<%= formattedProvenanceCredits %> <%= tt('common.labels.credits') %></span>
          </button>
        <% } %>
        <div class="score-box">
          <p class="score-label">Scor siguranÈ›Äƒ</p>
          <p class="score-value" style="color: <%= typeof scoreColor !== 'undefined' ? scoreColor : '#22c55e' %>;"><%= typeof riskScore !== 'undefined' ? riskScore : '9' %> / <%= riskScoreMaxValue %></p>
          <p class="score-text" style="color: <%= typeof scoreColor !== 'undefined' ? scoreColor : '#22c55e' %>;"><%= typeof riskText !== 'undefined' ? riskText : 'Telefon sigur' %></p>
        </div>
      </div>
    </div>

    <!-- INFORMATII CRITICE DE SECURITATE -->
    <% 
      // Ensure all critical variables are defined with defaults
      const blacklistSafe = typeof blacklist !== 'undefined' && blacklist ? blacklist : { status: 'unknown', text: 'Nu avem informaÈ›ii despre statusul blacklist' };
      const mdmSafe = typeof mdm !== 'undefined' ? mdm : null;
      const networkLockSafe = typeof networkLock !== 'undefined' && networkLock ? networkLock : { status: 'unknown', text: 'Nu avem informaÈ›ii despre blocarea reÈ›elei' };
      const warrantySafe = typeof warranty !== 'undefined' && warranty ? warranty : { hasInfo: false, text: 'Nu avem informaÈ›ii despre garanÈ›ie' };
      const originSafe = typeof origin !== 'undefined' && origin ? origin : { hasInfo: false, text: 'Nu avem informaÈ›ii despre provenienÈ›Äƒ' };
    %>
    <div class="critical-info-section">
      <div class="critical-info-card">
        <h3 class="critical-info-title">ğŸ”’ InformaÈ›ii Critice de Securitate</h3>
        
        <div class="critical-info-grid">
          <!-- 1. Blacklist Status -->
          <div class="critical-info-item">
            <div class="critical-info-label">Status Blacklist:</div>
            <div class="critical-info-value status-<%= blacklistSafe.status === 'blacklisted' ? 'danger' : blacklistSafe.status === 'clean' ? 'safe' : 'unknown' %>">
              <%= blacklistSafe.text %>
            </div>
          </div>
          
          <!-- 2. MDM Lock -->
          <% if (mdmSafe) { %>
          <div class="critical-info-item">
            <div class="critical-info-label">MDM Lock:</div>
            <div class="critical-info-value status-<%= mdmSafe.status === 'locked' ? 'warning' : mdmSafe.status === 'unlocked' ? 'safe' : 'unknown' %>">
              <%= mdmSafe.text %>
            </div>
          </div>
          <% } %>
          
          <!-- 3. Network Lock -->
          <div class="critical-info-item">
            <div class="critical-info-label">Blocare ReÈ›ea:</div>
            <div class="critical-info-value status-<%= networkLockSafe.status === 'locked' ? 'danger' : networkLockSafe.status === 'locked_orange' ? 'warning' : networkLockSafe.status === 'unlocked' ? 'safe' : 'unknown' %>">
              <%= networkLockSafe.text %>
            </div>
          </div>
          
          <!-- 4. Warranty Info -->
          <div class="critical-info-item">
            <div class="critical-info-label">GaranÈ›ie:</div>
            <div class="critical-info-value status-<%= warrantySafe.hasInfo ? (warrantySafe.status === 'active' ? 'safe' : warrantySafe.status === 'expired' ? 'warning' : 'unknown') : 'unknown' %>">
              <%= warrantySafe.text %>
            </div>
          </div>
          
          <!-- 5. Origin Info -->
          <div class="critical-info-item">
            <div class="critical-info-label">ProvenienÈ›Äƒ:</div>
            <div class="critical-info-value <%= originSafe.hasInfo ? '' : 'status-unknown' %>">
              <%= originSafe.text %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALERTE (dacÄƒ sunt probleme critice) -->
    <% if (blacklistSafe && blacklistSafe.status === 'blacklisted') { %>
      <div class="alert-box" style="background-color: rgba(239, 68, 68, 0.1); border-left-color: #ef4444;">
        <div class="alert-icon">ğŸš«</div>
        <div class="alert-content">
          <p><strong>Dispozitiv Blocat/Furat</strong></p>
          <p>Dispozitivul este Ã®nregistrat Ã®n baza de date ca blocat sau furat. <strong>NU CUMPÄ‚RA</strong> acest dispozitiv.</p>
        </div>
      </div>
    <% } %>

    <!-- INFORMATII SUPLIMENTARE -->
    <div class="report-grid">
      <!-- IDENTIFICARE -->
      <div class="report-card">
        <h3>Identificare dispozitiv</h3>
        <p>Model: <strong><%= model.replace(/\(Unlocked\)/gi, '').trim() %></strong></p>
        <% if (description && description !== model) { %>
          <p>Descriere: <strong><%= description.replace(/\(Unlocked\)/gi, '').trim() %></strong></p>
        <% } %>
        <% if (modelNumber) { %>
          <p>Model Number: <strong><%= modelNumber %></strong></p>
        <% } %>
        <p>IMEI: <strong><%= imei %></strong></p>
        <% if (serial) { %>
          <p>Serial Number: <strong><%= serial %></strong></p>
        <% } %>
      </div>
      
      <!-- SPECIFICAÈšII -->
      <div class="report-card">
        <h3>SpecificaÈ›ii dispozitiv</h3>
        <% if (color) { %>
          <p>Culoare: <strong><%= color %></strong></p>
        <% } %>
        <% if (size) { %>
          <p>Capacitate stocare: <strong><%= size %></strong></p>
        <% } %>
        <% if (yearManufactured) { %>
          <p>An fabricaÈ›ie: <strong><%= yearManufactured %></strong></p>
        <% } %>
        <% if (activationStatus) { %>
          <p>Status activare: <strong><%= activationStatus %></strong></p>
        <% } %>
      </div>
      
      <!-- GARANÈšIE & ACOPERIRE -->
      <div class="report-card">
        <h3>GaranÈ›ie & acoperire</h3>
        <% if (warrantySafe && warrantySafe.hasInfo) { %>
          <p>Status garanÈ›ie: <strong><%= warrantySafe.status === 'active' ? 'Ãn garanÈ›ie' : warrantySafe.status === 'expired' ? 'GaranÈ›ie expiratÄƒ' : warrantySafe.text %></strong></p>
          <% if (warrantySafe.endDate) { %>
            <p>Data expirare: <strong><%= typeof formatDate !== 'undefined' ? formatDate(warrantySafe.endDate.toISOString()) : warrantyEndDate %></strong></p>
          <% } else if (warrantyEndDate) { %>
            <p>Data expirare: <strong><%= warrantyEndDate %></strong></p>
          <% } %>
        <% } else if (pixelData.warranty) { %>
          <p>Detalii garanÈ›ie: <strong><%= pixelData.warranty %></strong></p>
        <% } else { %>
          <p>Status garanÈ›ie: <strong>Nu avem informaÈ›ii despre garanÈ›ie</strong></p>
        <% } %>
        <p class="form-hint">âš ï¸ VerificÄƒ mereu factura originalÄƒ â€“ datele pot fi doar estimative.</p>
      </div>
      
      <!-- REÈšEA & STATUS -->
      <div class="report-card">
        <h3>ReÈ›ea & status</h3>
        <div class="critical-info-item" style="margin-bottom: 15px;">
          <div class="critical-info-label">Blocare ReÈ›ea:</div>
          <div class="critical-info-value status-<%= networkLockSafe.status === 'locked' ? 'danger' : networkLockSafe.status === 'locked_orange' ? 'warning' : networkLockSafe.status === 'unlocked' ? 'safe' : 'unknown' %>" style="margin-top: 5px;">
            <%= networkLockSafe.text %>
          </div>
        </div>
        <% if (activationStatus) { %>
          <p>Status activare: <strong><%= activationStatus %></strong></p>
        <% } %>
        <p class="form-hint">ğŸ‘‰ VerificÄƒ dacÄƒ dispozitivul funcÈ›ioneazÄƒ cu cartelele SIM tale.</p>
      </div>
    </div>

    <!-- VERIFICÄ‚RI SUPLIMENTARE -->
    <% if (typeof additionalResults !== 'undefined' && additionalResults && additionalResults.length > 0) { %>
      <div class="additional-results-section">
        <h2 class="section-title">VerificÄƒri suplimentare</h2>
        <p class="section-subtitle">Rezultatele verificÄƒrilor suplimentare pe care le-ai solicitat</p>
        
        <% additionalResults.forEach((item, index) => { %>
          <div class="additional-result-card">
            <div class="additional-result-header">
              <h3>
                <span class="result-icon">
                  <% if (item.service.category === 'ProvenienÈ›Äƒ') { %>ğŸ”<% } else if (item.service.category === 'Securitate') { %>ğŸ›¡ï¸<% } else { %>ğŸ“±<% } %>
                </span>
                <%= item.service.displayName || item.service.name %>
              </h3>
              <span class="result-category"><%= item.service.category || 'Verificare' %></span>
            </div>
            
            <div class="additional-result-description">
              <p><%= item.service.description %></p>
            </div>
            
            <div class="additional-result-content">
              <pre class="result-raw"><%= item.formattedResult %></pre>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- SFATURI -->
    <div class="report-tips">
      <h3>Sfaturi pentru cumpÄƒrÄƒtor</h3>
      <ol>
        <li>VerificÄƒ dacÄƒ dispozitivul este Ã®n garanÈ›ie È™i dacÄƒ garanÈ›ia este valabilÄƒ Ã®n È›ara ta.</li>
        <li>VerificÄƒ dacÄƒ dispozitivul nu este blocat (blacklist).</li>
        <li>ReseteazÄƒ complet dispozitivul È™i verificÄƒ dacÄƒ nu mai cere cont vechi.</li>
        <li>VerificÄƒ factura È™i provenienÈ›a.</li>
        <li>TesteazÄƒ toate funcÈ›iile hardware (camera, microfon, difuzor).</li>
        <li>VerificÄƒ starea bateriei Ã®n setÄƒri.</li>
        <li>AsigurÄƒ-te cÄƒ toate actualizÄƒrile software sunt instalate.</li>
      </ol>
    </div>

    <!-- CONCLUZIE -->
    <div class="report-conclusion">
      <div class="conclusion-box">
        <p><strong>Concluzie:</strong> <%= typeof summaryText !== 'undefined' ? summaryText : 'Dispozitivul este Ã®n regulÄƒ pentru achiziÈ›ie.' %></p>
      </div>
    </div>
  </div>

  <div class="result-actions">
    <a href="/verify/imei" class="btn btn-secondary">VerificÄƒ alt IMEI</a>
    <% if (user) { %>
      <a href="/dashboard/orders" class="btn btn-primary">Vezi toate verificÄƒrile</a>
    <% } %>
  </div>
</div>

<% if (!isEmailView) { %>
  <%- include('../partials/footer') %>
<% } %>

